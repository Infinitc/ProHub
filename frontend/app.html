<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyHub - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --savings: #3b82f6;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --shadow: 0 1px 3px 0 rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700; }
        .logo-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }

        .header-right { display: flex; align-items: center; gap: 0.75rem; }

        /* ========== DARK MODE TOGGLE ========== */
        .theme-toggle {
            position: relative;
            width: 52px; height: 28px;
            background: rgba(255,255,255,0.25);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .theme-toggle-thumb {
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; line-height: 1;
        }
        [data-theme="dark"] .theme-toggle-thumb { transform: translateX(24px); }
        .theme-toggle-icon-sun { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 11px; opacity: 0.7; }
        .theme-toggle-icon-moon { position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 11px; opacity: 0.7; }

        .user-info { display: flex; align-items: center; gap: 0.75rem; }
        .user-avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
        .btn-logout { padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s; }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }

        /* Navigation */
        .nav { background: var(--surface); padding: 0.5rem 2rem; display: flex; gap: 0.5rem; border-bottom: 1px solid var(--border); overflow-x: auto; position: sticky; top: 72px; z-index: 90; transition: background 0.3s; }
        .nav-btn { padding: 0.75rem 1.25rem; background: transparent; border: none; color: var(--text-light); cursor: pointer; font-weight: 600; border-radius: 8px; transition: all 0.2s; white-space: nowrap; font-size: 0.95rem; }
        .nav-btn:hover { background: var(--bg); color: var(--text); }
        .nav-btn.active { background: var(--primary); color: white; }

        /* Main */
        .main { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--surface); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--border); transition: background 0.3s, border-color 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .card-header h2 { font-size: 1.25rem; color: var(--text); font-weight: 600; }

        /* Notes Grid */
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .note-card { background: var(--surface); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .note-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary); }
        .note-card.priority-high { border-left: 4px solid var(--danger); }
        .note-card.priority-medium { border-left: 4px solid var(--warning); }
        .note-card.priority-low { border-left: 4px solid var(--success); }
        .note-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text); }
        .note-card p { color: var(--text-light); font-size: 0.9rem; line-height: 1.5; margin-bottom: 0.75rem; }
        .note-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-light); }
        .priority-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .priority-badge.high { background: #fee2e2; color: var(--danger); }
        .priority-badge.medium { background: #fef3c7; color: #d97706; }
        .priority-badge.low { background: #dcfce7; color: var(--success); }
        [data-theme="dark"] .priority-badge.high { background: rgba(239,68,68,0.2); }
        [data-theme="dark"] .priority-badge.medium { background: rgba(245,158,11,0.2); }
        [data-theme="dark"] .priority-badge.low { background: rgba(16,185,129,0.2); }

        /* Calendar */
        .calendar { background: var(--surface); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); max-width: 900px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h3 { font-size: 1.25rem; color: var(--text); }
        .calendar-nav { display: flex; gap: 0.5rem; }
        .calendar-nav button { padding: 0.5rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .calendar-day-header { text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light); font-size: 0.85rem; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0.3rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; position: relative; min-height: 55px; background: var(--surface); border: 1px solid var(--border); }
        .calendar-day:hover { background: var(--bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .calendar-day.today { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 2px 8px rgba(99,102,241,0.3); }
        .calendar-day-number { font-weight: 500; margin-bottom: 0.15rem; font-size: 0.85rem; }
        .calendar-day-notes { display: flex; flex-direction: column; gap: 2px; width: 100%; }
        .calendar-note-badge { padding: 2px 4px; border-radius: 3px; font-size: 0.6rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; text-align: center; }
        .calendar-note-badge.high { background: var(--danger); color: white; }
        .calendar-note-badge.medium { background: var(--warning); color: white; }
        .calendar-note-badge.low { background: var(--success); color: white; }

        /* FAB */
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(99,102,241,0.4); transition: all 0.3s; z-index: 1000; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(99,102,241,0.5); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; padding: 1rem; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: var(--surface); border-radius: 16px; padding: 2rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; border: 1px solid var(--border); }
        .modal-content-wide { max-width: 640px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { font-size: 1.5rem; color: var(--text); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .modal-close:hover { background: var(--bg); }

        /* Form */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; transition: all 0.2s; background: var(--surface); color: var(--text); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .form-group textarea { min-height: 120px; resize: vertical; }

        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-light); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: 0.5rem; color: var(--text); }

        /* Sync Button */
        .sync-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: var(--surface); border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .sync-btn:hover { background: var(--primary); color: white; }

        /* Finance Summary */
        .finance-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .finance-card { background: var(--surface); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); transition: background 0.3s; }
        .finance-card h4 { font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .finance-card .amount { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .finance-card.income .amount { color: var(--success); }
        .finance-card.expense .amount { color: var(--danger); }
        .finance-card.balance .amount { color: var(--primary); }
        .finance-card.savings-total { border-left: 4px solid var(--savings); }
        .finance-card.savings-total .amount { color: var(--savings); }

        /* Finance Tabs */
        .finance-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
        .finance-tab { padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; cursor: pointer; font-weight: 600; color: var(--text-light); font-size: 0.95rem; transition: all 0.2s; font-family: inherit; }
        .finance-tab:hover { color: var(--text); }
        .finance-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .finance-tab.tab-savings.active { color: var(--savings); border-bottom-color: var(--savings); }

        /* Transactions - Draggable */
        .transaction-list { list-style: none; }
        .transaction-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; background: var(--bg); border-radius: 8px; margin-bottom: 0.75rem;
            border: 1px solid var(--border); cursor: grab; user-select: none;
            transition: box-shadow 0.2s, transform 0.2s, opacity 0.2s;
        }
        .transaction-item:hover { box-shadow: var(--shadow-lg); }
        .transaction-item.dragging { opacity: 0.4; cursor: grabbing; }
        .transaction-item.drag-over { border: 2px dashed var(--primary); background: rgba(99,102,241,0.05); transform: scale(1.01); }
        .drag-handle { color: var(--text-light); margin-right: 0.75rem; font-size: 1.1rem; cursor: grab; flex-shrink: 0; }

        /* Savings Goals */
        .savings-goal-card { background: var(--surface); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow); border: 1px solid var(--border); border-left: 4px solid var(--savings); margin-bottom: 1rem; }
        .savings-goal-card h4 { font-size: 1rem; color: var(--text); margin-bottom: 0.25rem; font-weight: 600; }
        .savings-provider { font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.75rem; }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--savings), #60a5fa); border-radius: 4px; transition: width 0.6s ease; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-light); }
        .progress-labels .saved { color: var(--savings); font-weight: 700; }

        /* Note Detail */
        .note-detail-body { font-size: 1rem; line-height: 1.8; color: var(--text); white-space: pre-wrap; padding: 1rem; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); min-height: 100px; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .logo { font-size: 1.25rem; }
            .logo-icon { width: 32px; height: 32px; font-size: 1.25rem; }
            #username { display: none; }
            .user-avatar { width: 32px; height: 32px; }
            .btn-logout { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
            .nav { padding: 0.5rem 1rem; top: 55px; }
            .nav-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .main { padding: 1rem; }
            .notes-grid { grid-template-columns: 1fr; }
            .fab { bottom: 1rem; right: 1rem; width: 50px; height: 50px; }
            .calendar { padding: 1rem; max-width: 100%; }
            .calendar-day { min-height: 50px; font-size: 0.8rem; padding: 0.2rem; }
            .calendar-day-header { font-size: 0.75rem; }
            .card { padding: 1rem; }
            .modal-content { padding: 1.5rem; }
        }
        @media (max-width: 480px) {
            .calendar-day { min-height: 45px; font-size: 0.75rem; }
            .calendar-day-header { font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üíº</div>
            <span>PolyHub</span>
        </div>
        <div class="header-right">
            <!-- Dark Mode Toggle -->
            <button class="theme-toggle" onclick="toggleTheme()" title="Hell/Dunkel">
                <span class="theme-toggle-icon-moon">üåô</span>
                <span class="theme-toggle-icon-sun">‚òÄÔ∏è</span>
                <div class="theme-toggle-thumb">‚òÄÔ∏è</div>
            </button>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="username">Laden...</span>
                <button class="btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="showSection('notes', this)">üìù Notizen</button>
        <button class="nav-btn" onclick="showSection('calendar', this)">üìÖ Kalender</button>
        <button class="nav-btn" onclick="showSection('finance', this)">üí∞ Finanzen</button>
        <button class="nav-btn" onclick="showSection('mail', this)">üìß E-Mail</button>
    </div>

    <div class="main">
        <!-- NOTES -->
        <div id="notes" class="section active">
            <div style="display:flex;justify-content:flex-end;margin-bottom:1rem;">
                <select id="notesSortBy" onchange="loadNotes()" style="padding:0.5rem 1rem;border:2px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);cursor:pointer;font-weight:600;">
                    <option value="deadline">üìÖ Nach Deadline</option>
                    <option value="priority">‚ö° Nach Priorit√§t</option>
                    <option value="created">üïê Nach Erstellung</option>
                </select>
            </div>
            <div id="notes-grid" class="notes-grid"></div>
            <div id="notes-empty" class="empty-state" style="display:none;">
                <div class="empty-state-icon">üìù</div>
                <h3>Keine Notizen</h3>
                <p>Klicke auf + um deine erste Notiz zu erstellen</p>
            </div>
        </div>

        <!-- CALENDAR -->
        <div id="calendar" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>üìÖ Kalender</h2>
                    <button class="sync-btn" onclick="showCalDAVInfo()">üîÑ iOS Sync</button>
                </div>
                <div class="calendar">
                    <div class="calendar-header">
                        <h3 id="currentMonth">Februar 2026</h3>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()">‚óÄ</button>
                            <button onclick="nextMonth()">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2>Anstehende Termine</h2></div>
                <div id="events-list"></div>
            </div>
        </div>

        <!-- FINANCE -->
        <div id="finance" class="section">
            <div id="finance-summary" class="finance-summary"></div>
            <div class="card">
                <div class="finance-tabs">
                    <button class="finance-tab active" id="tab-transactions" onclick="switchTab('transactions')">üí≥ Transaktionen</button>
                    <button class="finance-tab tab-savings" id="tab-savings" onclick="switchTab('savings')">üè¶ Sparen</button>
                </div>
                <!-- Transactions -->
                <div id="panel-transactions">
                    <div class="card-header">
                        <h2>Letzte Transaktionen</h2>
                        <span style="font-size:0.8rem;color:var(--text-light);">‚†ø ziehen zum Sortieren</span>
                    </div>
                    <ul class="transaction-list" id="transactions-list"></ul>
                </div>
                <!-- Savings -->
                <div id="panel-savings" style="display:none;">
                    <div class="card-header"><h2>Meine Sparziele</h2></div>
                    <div id="savings-list"></div>
                </div>
            </div>
        </div>

        <!-- MAIL -->
        <div id="mail" class="section">
            <div class="empty-state">
                <div class="empty-state-icon">üìß</div>
                <h3>E-Mail Funktion</h3>
                <p>Kommt bald...</p>
            </div>
        </div>
    </div>

    <button class="fab" id="fab" onclick="openCreateModal()">+</button>

    <!-- CREATE MODAL -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Neue Notiz</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Titel</label>
                <input type="text" id="itemTitle" placeholder="Titel eingeben...">
            </div>
            <div class="form-group" id="contentGroup">
                <label>Inhalt</label>
                <textarea id="itemContent" placeholder="Inhalt..."></textarea>
            </div>
            <div class="form-group" id="priorityGroup">
                <label>Priorit√§t</label>
                <select id="itemPriority">
                    <option value="low">üü¢ Niedrig</option>
                    <option value="medium" selected>üü° Mittel</option>
                    <option value="high">üî¥ Hoch</option>
                </select>
            </div>
            <div class="form-group" id="deadlineGroup" style="display:none;">
                <label>F√§lligkeitsdatum</label>
                <input type="date" id="itemDeadline">
            </div>
            <div class="form-group" id="calendarCheckGroup" style="display:none;">
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                    <input type="checkbox" id="itemInCalendar" style="width:auto;cursor:pointer;">
                    <span>üìÖ Als Termin im Kalender eintragen</span>
                </label>
            </div>
            <div class="form-group" id="dateGroup" style="display:none;">
                <label>Datum</label>
                <input type="date" id="itemDate">
            </div>
            <div class="form-group" id="amountGroup" style="display:none;">
                <label>Betrag (‚Ç¨)</label>
                <input type="number" step="0.01" id="itemAmount" placeholder="0.00">
            </div>
            <div class="form-group" id="typeGroup" style="display:none;">
                <label>Typ</label>
                <select id="itemType">
                    <option value="expense">Ausgabe</option>
                    <option value="income">Einnahme</option>
                </select>
            </div>
            <div class="form-group" id="recurringGroup" style="display:none;">
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-bottom:0.75rem;">
                    <input type="checkbox" id="itemRecurring" onchange="toggleRecurringInterval()" style="width:auto;cursor:pointer;">
                    <span>üîÑ Dauerauftrag (wiederkehrend)</span>
                </label>
                <div id="recurringIntervalGroup" style="display:none;">
                    <label>Intervall</label>
                    <select id="itemRecurringInterval">
                        <option value="weekly">W√∂chentlich</option>
                        <option value="monthly" selected>Monatlich</option>
                        <option value="yearly">J√§hrlich</option>
                    </select>
                </div>
            </div>
            <!-- Savings fields -->
            <div class="form-group" id="savingsTargetGroup" style="display:none;">
                <label>Sparziel (‚Ç¨)</label>
                <input type="number" step="0.01" id="itemSavingsTarget" placeholder="z.B. 5000.00">
            </div>
            <div class="form-group" id="savingsCurrentGroup" style="display:none;">
                <label>Bereits gespart (‚Ç¨)</label>
                <input type="number" step="0.01" id="itemSavingsCurrent" placeholder="0.00" value="0">
            </div>
            <div class="form-group" id="savingsProviderGroup" style="display:none;">
                <label>Anbieter / Konto</label>
                <input type="text" id="itemSavingsProvider" placeholder="z.B. Trade Republic, Bausparkasse...">
            </div>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button>
                <button class="btn btn-primary" style="flex:1;" onclick="submitModal()">Erstellen</button>
            </div>
        </div>
    </div>

    <!-- NOTE DETAIL MODAL -->
    <div class="modal" id="noteDetailModal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <div style="flex:1;min-width:0;">
                    <h2 id="noteDetailTitle" style="margin-bottom:0.25rem;word-break:break-word;"></h2>
                    <div id="noteDetailMeta" style="font-size:0.85rem;color:var(--text-light);display:flex;gap:0.75rem;flex-wrap:wrap;"></div>
                </div>
                <button class="modal-close" onclick="closeNoteDetail()" style="margin-left:1rem;">&times;</button>
            </div>
            <div id="noteDetailBody" class="note-detail-body"></div>
            <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeNoteDetail()">Schlie√üen</button>
                <button class="btn btn-danger" style="flex:1;" id="noteDetailDeleteBtn">üóëÔ∏è L√∂schen</button>
            </div>
        </div>
    </div>

    <script>
// ========== CONFIG ==========
const API_BASE = '/api';
let token = null;
let currentSection = 'notes';
let currentMonth = new Date();
let events = [];
let currentActiveTab = 'transactions';
let dragSrcEl = null;

// ========== INIT ==========
window.addEventListener('DOMContentLoaded', () => {
    token = localStorage.getItem('token');
    if (!token) { window.location.href = '/login.html'; return; }

    // Apply saved theme
    const saved = localStorage.getItem('polyhub-theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    updateThumbIcon(saved);

    verifyAuth();
    loadNotes();
    renderCalendar();
    document.getElementById('itemDate').value = new Date().toISOString().split('T')[0];
});

// ========== THEME ==========
function toggleTheme() {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('polyhub-theme', next);
    updateThumbIcon(next);
}
function updateThumbIcon(theme) {
    const thumb = document.querySelector('.theme-toggle-thumb');
    if (thumb) thumb.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// ========== AUTH ==========
async function verifyAuth() {
    try {
        const r = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (r.status === 401) { return; }
        if (!r.ok) throw new Error();
        const user = await r.json();
        document.getElementById('username').textContent = user.username;
        document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
    } catch(e) { console.error('Auth error:', e); }
}

function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

async function apiCall(endpoint, options = {}) {
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
    try {
        const r = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
        if (r.status === 401) { logout(); return null; }
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        if (r.status === 204) return null;
        return await r.json();
    } catch(e) { console.error('API Error:', e); throw e; }
}

// ========== NAVIGATION ==========
function showSection(sectionId, btn) {
    currentSection = sectionId;
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    if (btn) btn.classList.add('active');
    if (sectionId === 'notes') loadNotes();
    if (sectionId === 'calendar') { loadEvents(); renderCalendar(); }
    if (sectionId === 'finance') { loadTransactions(); loadFinanceSummary(); loadSavings(); }
}

// ========== FINANCE TABS ==========
function switchTab(tab) {
    currentActiveTab = tab;
    document.getElementById('panel-transactions').style.display = tab === 'transactions' ? 'block' : 'none';
    document.getElementById('panel-savings').style.display = tab === 'savings' ? 'block' : 'none';
    document.getElementById('tab-transactions').classList.toggle('active', tab === 'transactions');
    document.getElementById('tab-savings').classList.toggle('active', tab === 'savings');
}

// ========== MODAL ==========
function openCreateModal() {
    // Reset all fields
    ['itemTitle','itemContent','itemAmount','itemSavingsTarget','itemSavingsProvider'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('itemSavingsCurrent').value = '0';
    document.getElementById('itemPriority').value = 'medium';
    document.getElementById('itemRecurring').checked = false;
    document.getElementById('itemInCalendar').checked = false;
    document.getElementById('recurringIntervalGroup').style.display = 'none';

    const allGroups = ['contentGroup','priorityGroup','deadlineGroup','calendarCheckGroup','dateGroup','amountGroup','typeGroup','recurringGroup','savingsTargetGroup','savingsCurrentGroup','savingsProviderGroup'];
    allGroups.forEach(id => document.getElementById(id).style.display = 'none');

    if (currentSection === 'notes') {
        document.getElementById('modalTitle').textContent = 'Neue Notiz';
        ['contentGroup','priorityGroup','deadlineGroup','calendarCheckGroup'].forEach(id => document.getElementById(id).style.display = 'block');
        document.getElementById('itemDeadline').value = '';
    } else if (currentSection === 'calendar') {
        document.getElementById('modalTitle').textContent = 'Neuer Termin';
        ['contentGroup','dateGroup'].forEach(id => document.getElementById(id).style.display = 'block');
        document.getElementById('itemDate').value = new Date().toISOString().split('T')[0];
    } else if (currentSection === 'finance') {
        if (currentActiveTab === 'savings') {
            document.getElementById('modalTitle').textContent = 'Neues Sparziel';
            ['savingsTargetGroup','savingsCurrentGroup','savingsProviderGroup'].forEach(id => document.getElementById(id).style.display = 'block');
        } else {
            document.getElementById('modalTitle').textContent = 'Neue Transaktion';
            ['dateGroup','amountGroup','typeGroup','recurringGroup'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('itemDate').value = new Date().toISOString().split('T')[0];
        }
    }
    document.getElementById('createModal').classList.add('active');
}

function closeModal() { document.getElementById('createModal').classList.remove('active'); }
function toggleRecurringInterval() {
    document.getElementById('recurringIntervalGroup').style.display = document.getElementById('itemRecurring').checked ? 'block' : 'none';
}

async function submitModal() {
    if (currentSection === 'notes') await createNote();
    else if (currentSection === 'calendar') await createEvent();
    else if (currentSection === 'finance' && currentActiveTab === 'savings') await createSavingsGoal();
    else if (currentSection === 'finance') await createTransaction();
    closeModal();
}

// ========== NOTES ==========
async function loadNotes() {
    try {
        const notes = await apiCall('/notes/');
        const gridEl = document.getElementById('notes-grid');
        const emptyEl = document.getElementById('notes-empty');
        const sortBy = document.getElementById('notesSortBy')?.value || 'deadline';
        gridEl.innerHTML = '';

        if (notes && notes.length > 0) {
            notes.sort((a, b) => {
                if (sortBy === 'deadline') {
                    const dA = a.deadline ? new Date(a.deadline) : null, dB = b.deadline ? new Date(b.deadline) : null;
                    if (dA && dB) return dA - dB;
                    if (dA) return -1; if (dB) return 1;
                    return ({high:0,medium:1,low:2}[a.priority]) - ({high:0,medium:1,low:2}[b.priority]);
                } else if (sortBy === 'priority') {
                    return ({high:0,medium:1,low:2}[a.priority]) - ({high:0,medium:1,low:2}[b.priority]);
                } else { return new Date(b.created_at) - new Date(a.created_at); }
            });

            notes.forEach(note => {
                const isOverdue = note.deadline && new Date(note.deadline) < new Date();
                const prioLabel = {high:'üî¥ Hoch', medium:'üü° Mittel', low:'üü¢ Niedrig'}[note.priority];
                let deadlineHtml = '';
                if (note.deadline) {
                    const fmt = new Date(note.deadline).toLocaleDateString('de-DE', {day:'2-digit', month:'short'});
                    const style = isOverdue ? 'color:var(--danger);font-weight:700;' : 'color:var(--text-light);';
                    deadlineHtml = `<div style="${style}font-size:0.85rem;margin-bottom:0.5rem;">üìÖ ${fmt}${isOverdue?' (√ºberf√§llig!)':''}</div>`;
                }
                const preview = escapeHtml(note.content.substring(0,120)) + (note.content.length > 120 ? '...' : '');
                const card = document.createElement('div');
                card.className = `note-card priority-${note.priority}`;
                if (isOverdue) card.style.borderLeftColor = 'var(--danger)';
                card.innerHTML = `
                    ${deadlineHtml}
                    <h3>${escapeHtml(note.title)}</h3>
                    <p>${preview}</p>
                    <div class="note-meta">
                        <span class="priority-badge ${note.priority}" style="font-size:0.85rem;padding:0.4rem 0.9rem;">${prioLabel}</span>
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation();deleteNoteConfirm(${note.id})" style="padding:0.35rem 0.75rem;font-size:0.8rem;">üóëÔ∏è L√∂schen</button>
                    </div>`;
                // CLICKABLE - opens detail modal
                card.addEventListener('click', () => openNoteDetail(note));
                gridEl.appendChild(card);
            });
            emptyEl.style.display = 'none';
        } else {
            emptyEl.style.display = 'block';
        }
    } catch(e) { console.error('Error loading notes:', e); }
}

// ========== NOTE DETAIL MODAL ==========
function openNoteDetail(note) {
    const prioLabel = {high:'üî¥ Hoch', medium:'üü° Mittel', low:'üü¢ Niedrig'}[note.priority];
    document.getElementById('noteDetailTitle').textContent = note.title;
    let meta = `<span>${prioLabel}</span>`;
    if (note.deadline) {
        const d = new Date(note.deadline);
        const isOverdue = d < new Date();
        const style = isOverdue ? 'color:var(--danger);font-weight:600;' : '';
        meta += `<span style="${style}">üìÖ ${d.toLocaleDateString('de-DE')}${isOverdue?' ‚ö†Ô∏è':''}</span>`;
    }
    meta += `<span>üìù ${new Date(note.created_at).toLocaleDateString('de-DE')}</span>`;
    document.getElementById('noteDetailMeta').innerHTML = meta;
    document.getElementById('noteDetailBody').textContent = note.content;
    document.getElementById('noteDetailDeleteBtn').onclick = () => { closeNoteDetail(); deleteNoteConfirm(note.id); };
    document.getElementById('noteDetailModal').classList.add('active');
}

function closeNoteDetail() { document.getElementById('noteDetailModal').classList.remove('active'); }

async function createNote() {
    const title = document.getElementById('itemTitle').value;
    const content = document.getElementById('itemContent').value;
    const priority = document.getElementById('itemPriority').value;
    const deadline = document.getElementById('itemDeadline').value;
    const inCalendar = document.getElementById('itemInCalendar').checked;
    if (!title || !content) { alert('Bitte Titel und Inhalt eingeben'); return; }
    try {
        const data = { title, content, priority, in_calendar: inCalendar };
        if (deadline) data.deadline = deadline;
        await apiCall('/notes/', { method: 'POST', body: JSON.stringify(data) });
        if (inCalendar && deadline) {
            try { await apiCall('/calendar/', { method: 'POST', body: JSON.stringify({ title: `üìù ${title}`, date: deadline, description: content.substring(0,200), priority }) }); }
            catch(e) {}
        }
        loadNotes();
    } catch(e) { alert('Fehler beim Erstellen'); }
}

function deleteNoteConfirm(id) {
    showConfirmModal('Notiz l√∂schen?', 'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.', () => deleteNote(id));
}
async function deleteNote(id) {
    try { await apiCall(`/notes/${id}`, { method: 'DELETE' }); loadNotes(); }
    catch(e) { alert('Fehler beim L√∂schen'); }
}

// ========== CALENDAR ==========
async function loadEvents() {
    try { events = await apiCall('/calendar/') || []; renderEventsList(); }
    catch(e) { console.error(e); }
}

function renderCalendar() {
    const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
    const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d => {
        const h = document.createElement('div'); h.className = 'calendar-day-header'; h.textContent = d; grid.appendChild(h);
    });
    const startDay = firstDay === 0 ? 6 : firstDay - 1;
    for (let i = 0; i < startDay; i++) grid.appendChild(document.createElement('div'));
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const el = document.createElement('div');
        el.className = 'calendar-day';
        el.innerHTML = `<div class="calendar-day-number">${day}</div>`;
        if (today.getDate()===day && today.getMonth()===month && today.getFullYear()===year) el.classList.add('today');
        grid.appendChild(el);
    }
    apiCall('/notes/').then(notes => {
        if (!notes) return;
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const dayNotes = notes.filter(n => n.deadline === dateStr);
            const dayEvents = events.filter(e => e.date === dateStr);
            const idx = startDay + day - 1 + 7;
            const el = grid.children[idx];
            if (el && (dayNotes.length > 0 || dayEvents.length > 0)) {
                let html = `<div class="calendar-day-number">${day}</div><div class="calendar-day-notes">`;
                dayNotes.slice(0,2).forEach(n => { html += `<div class="calendar-note-badge ${n.priority}">${n.title.substring(0,8)}</div>`; });
                el.innerHTML = html + '</div>';
            }
        }
    });
}

function renderEventsList() {
    const listEl = document.getElementById('events-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    const now = new Date(); now.setHours(0,0,0,0);
    const upcoming = (events||[]).filter(e => new Date(e.date) >= now).sort((a,b) => new Date(a.date)-new Date(b.date)).slice(0,5);
    if (upcoming.length > 0) {
        upcoming.forEach(ev => {
            const item = document.createElement('div');
            item.style.cssText = 'padding:1rem;background:var(--bg);border-radius:8px;margin-bottom:0.75rem;border:1px solid var(--border);';
            item.innerHTML = `<h4 style="margin-bottom:0.25rem;">${escapeHtml(ev.title)}</h4><p style="color:var(--text-light);font-size:0.9rem;">${new Date(ev.date).toLocaleDateString('de-DE',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>${ev.description?`<p style="margin-top:0.5rem;font-size:0.9rem;">${escapeHtml(ev.description)}</p>`:''}`;
            listEl.appendChild(item);
        });
    } else {
        listEl.innerHTML = '<p style="text-align:center;color:var(--text-light);">Keine anstehenden Termine</p>';
    }
}

function previousMonth() { currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1); renderCalendar(); }
function nextMonth() { currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1); renderCalendar(); }

async function createEvent() {
    const title = document.getElementById('itemTitle').value;
    const date = document.getElementById('itemDate').value;
    const description = document.getElementById('itemContent').value;
    if (!title || !date) { alert('Bitte Titel und Datum eingeben'); return; }
    try {
        await apiCall('/calendar/', { method: 'POST', body: JSON.stringify({ title, date, description, priority: 'medium' }) });
        loadEvents(); renderCalendar();
    } catch(e) { alert('Fehler beim Erstellen'); }
}

function showCalDAVInfo() {
    const m = document.createElement('div');
    m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:3000;padding:1rem;';
    m.innerHTML = `<div style="background:var(--surface);padding:2rem;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;"><h3 style="color:var(--text);">üì± iOS CalDAV Sync</h3><button onclick="this.closest('div').parentElement.parentElement.remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light);">&times;</button></div>
        <div style="background:var(--bg);padding:1rem;border-radius:8px;margin-bottom:1rem;">
            <h4 style="margin-bottom:0.5rem;color:var(--text);">Einstellungen ‚Üí Kalender ‚Üí Accounts</h4>
            <p style="color:var(--text-light);font-size:0.9rem;margin-bottom:1rem;">Account hinzuf√ºgen ‚Üí Andere ‚Üí CalDAV-Account hinzuf√ºgen</p>
            <div style="margin-bottom:0.75rem;"><strong style="color:var(--text);">Server:</strong><code style="background:var(--surface);padding:0.25rem 0.5rem;border-radius:4px;display:block;margin-top:0.25rem;color:var(--text);">polypaul.de</code></div>
            <div style="margin-bottom:0.75rem;"><strong style="color:var(--text);">Benutzername:</strong><code style="background:var(--surface);padding:0.25rem 0.5rem;border-radius:4px;display:block;margin-top:0.25rem;color:var(--text);">paul</code></div>
            <div style="margin-bottom:0.75rem;"><strong style="color:var(--text);">Port:</strong><code style="background:var(--surface);padding:0.25rem 0.5rem;border-radius:4px;display:inline-block;margin-top:0.25rem;color:var(--text);">443</code> &nbsp;<strong style="color:var(--text);">SSL:</strong><span style="color:var(--success);font-weight:600;"> ‚úì AN</span></div>
            <div><strong style="color:var(--text);">Account-URL:</strong><code style="background:var(--surface);padding:0.25rem 0.5rem;border-radius:4px;display:block;margin-top:0.25rem;font-size:0.85rem;color:var(--text);">https://polypaul.de/radicale/paul/</code></div>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="this.closest('div').parentElement.parentElement.remove()">Verstanden</button>
    </div>`;
    document.body.appendChild(m);
}

// ========== FINANCE ==========
async function loadFinanceSummary() {
    try {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().split('T')[0];
        const summary = await apiCall(`/finance/summary?start_date=${firstDay}&end_date=${lastDay}`);
        const monthName = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'][now.getMonth()];
        if (summary) {
            document.getElementById('finance-summary').innerHTML = `
                <div class="finance-card income"><h4>Einnahmen ${monthName}</h4><div class="amount">+${parseFloat(summary.total_income).toFixed(2)} ‚Ç¨</div></div>
                <div class="finance-card expense"><h4>Ausgaben ${monthName}</h4><div class="amount">-${parseFloat(summary.total_expense).toFixed(2)} ‚Ç¨</div></div>
                <div class="finance-card balance"><h4>Bilanz ${monthName}</h4><div class="amount">${parseFloat(summary.balance).toFixed(2)} ‚Ç¨</div></div>
                <div class="finance-card savings-total"><h4>üí∞ Gespart gesamt</h4><div class="amount" id="totalSaved">‚Äî</div></div>`;
            loadSavingsTotalAmount();
        }
    } catch(e) { console.error(e); }
}

async function loadSavingsTotalAmount() {
    try {
        const savings = await apiCall('/finance/savings');
        if (savings) {
            const total = savings.reduce((s, g) => s + parseFloat(g.current_amount || 0), 0);
            const el = document.getElementById('totalSaved');
            if (el) el.textContent = `${total.toFixed(2)} ‚Ç¨`;
        }
    } catch(e) {}
}

// ========== TRANSACTIONS (DRAGGABLE) ==========
async function loadTransactions() {
    try {
        const transactions = await apiCall('/finance/transactions?limit=20');
        const listEl = document.getElementById('transactions-list');
        listEl.innerHTML = '';
        if (transactions && transactions.length > 0) {
            transactions.forEach((t, idx) => {
                const li = buildTransactionItem(t, idx);
                listEl.appendChild(li);
            });
        } else {
            listEl.innerHTML = '<li style="text-align:center;color:var(--text-light);padding:2rem;">Keine Transaktionen</li>';
        }
    } catch(e) { console.error(e); }
}

function buildTransactionItem(t, idx) {
    const li = document.createElement('li');
    li.className = 'transaction-item';
    li.draggable = true;
    li.dataset.id = t.id;
    const color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
    const sign = t.type === 'income' ? '+' : '-';
    const badge = t.is_recurring ? '<span style="background:var(--primary);color:white;padding:0.2rem 0.5rem;border-radius:12px;font-size:0.75rem;margin-left:0.5rem;">üîÑ</span>' : '';
    li.innerHTML = `
        <div style="display:flex;align-items:center;min-width:0;">
            <span class="drag-handle">‚†ø</span>
            <div style="min-width:0;">
                <h4 style="color:var(--text);">${escapeHtml(t.title)}${badge}</h4>
                <p style="color:var(--text-light);font-size:0.85rem;">${new Date(t.date).toLocaleDateString('de-DE')}</p>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;flex-shrink:0;">
            <div style="color:${color};font-weight:700;font-size:1.25rem;">${sign}${parseFloat(t.amount).toFixed(2)} ‚Ç¨</div>
            <button class="btn btn-danger btn-small" onclick="deleteTransactionConfirm(${t.id})" style="padding:0.35rem 0.75rem;font-size:0.8rem;">üóëÔ∏è</button>
        </div>`;
    // Drag events
    li.addEventListener('dragstart', e => { dragSrcEl = li; li.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
    li.addEventListener('dragend', () => { li.classList.remove('dragging'); document.querySelectorAll('.transaction-item').forEach(el => el.classList.remove('drag-over')); dragSrcEl = null; });
    li.addEventListener('dragover', e => { e.preventDefault(); if (dragSrcEl && dragSrcEl !== li) li.classList.add('drag-over'); });
    li.addEventListener('dragleave', () => li.classList.remove('drag-over'));
    li.addEventListener('drop', e => {
        e.preventDefault();
        li.classList.remove('drag-over');
        if (dragSrcEl && dragSrcEl !== li) {
            const list = li.parentElement;
            const items = [...list.children];
            const srcIdx = items.indexOf(dragSrcEl);
            const tgtIdx = items.indexOf(li);
            if (srcIdx < tgtIdx) list.insertBefore(dragSrcEl, li.nextSibling);
            else list.insertBefore(dragSrcEl, li);
        }
    });
    return li;
}

function deleteTransactionConfirm(id) {
    showConfirmModal('Transaktion l√∂schen?', 'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.', () => deleteTransaction(id));
}
async function deleteTransaction(id) {
    try { await apiCall(`/finance/transactions/${id}`, { method: 'DELETE' }); loadTransactions(); loadFinanceSummary(); }
    catch(e) { alert('Fehler beim L√∂schen'); }
}

async function createTransaction() {
    const title = document.getElementById('itemTitle').value;
    const amount = document.getElementById('itemAmount').value;
    const type = document.getElementById('itemType').value;
    const date = document.getElementById('itemDate').value;
    const isRecurring = document.getElementById('itemRecurring').checked;
    const recurringInterval = document.getElementById('itemRecurringInterval').value;
    if (!title || !amount || !date) { alert('Bitte alle Felder ausf√ºllen'); return; }
    try {
        await apiCall('/finance/transactions', { method: 'POST', body: JSON.stringify({ title, amount: parseFloat(amount), type, date, is_recurring: isRecurring, recurring_interval: isRecurring ? recurringInterval : null }) });
        loadTransactions(); loadFinanceSummary();
    } catch(e) { alert('Fehler beim Erstellen'); }
}

// ========== SAVINGS GOALS ==========
async function loadSavings() {
    try {
        const savings = await apiCall('/finance/savings');
        const listEl = document.getElementById('savings-list');
        listEl.innerHTML = '';
        if (savings && savings.length > 0) {
            savings.forEach(s => {
                const target = parseFloat(s.target_amount || 0);
                const current = parseFloat(s.current_amount || 0);
                const pct = target > 0 ? Math.min((current / target) * 100, 100) : 0;
                const card = document.createElement('div');
                card.className = 'savings-goal-card';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">
                        <div>
                            <h4>${escapeHtml(s.title)}</h4>
                            ${s.description ? `<div class="savings-provider">üè¶ ${escapeHtml(s.description)}</div>` : ''}
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteSavingsConfirm(${s.id})" style="padding:0.35rem 0.75rem;font-size:0.8rem;flex-shrink:0;margin-left:0.5rem;">üóëÔ∏è</button>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    <div class="progress-labels">
                        <span class="saved">${current.toFixed(2)} ‚Ç¨ gespart</span>
                        <span>${pct.toFixed(0)}% ¬∑ Ziel: ${target.toFixed(2)} ‚Ç¨</span>
                    </div>`;
                listEl.appendChild(card);
            });
        } else {
            listEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üè¶</div><h3>Keine Sparziele</h3><p>Klicke auf + um dein erstes Sparziel anzulegen</p></div>`;
        }
    } catch(e) { console.error(e); }
}

async function createSavingsGoal() {
    const title = document.getElementById('itemTitle').value;
    const target = parseFloat(document.getElementById('itemSavingsTarget').value);
    const current = parseFloat(document.getElementById('itemSavingsCurrent').value || 0);
    const provider = document.getElementById('itemSavingsProvider').value;
    if (!title || !target) { alert('Bitte Titel und Sparziel eingeben'); return; }
    try {
        await apiCall('/finance/savings', { method: 'POST', body: JSON.stringify({ title, target_amount: target, current_amount: current, description: provider }) });
        loadSavings(); loadFinanceSummary();
    } catch(e) { alert('Fehler beim Erstellen'); }
}

function deleteSavingsConfirm(id) {
    showConfirmModal('Sparziel l√∂schen?', 'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.', async () => {
        try { await apiCall(`/finance/savings/${id}`, { method: 'DELETE' }); loadSavings(); loadFinanceSummary(); }
        catch(e) { alert('Fehler beim L√∂schen'); }
    });
}

// ========== CONFIRM MODAL HELPER ==========
function showConfirmModal(title, message, onConfirm) {
    const m = document.createElement('div');
    m.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:3000;';
    m.innerHTML = `<div style="background:var(--surface);padding:2rem;border-radius:16px;max-width:400px;text-align:center;border:1px solid var(--border);margin:1rem;">
        <h3 style="margin-bottom:1rem;color:var(--text);">${title}</h3>
        <p style="margin-bottom:1.5rem;color:var(--text-light);">${message}</p>
        <div style="display:flex;gap:0.75rem;">
            <button class="btn btn-secondary" style="flex:1;" onclick="this.closest('[style*=fixed]').remove()">Abbrechen</button>
            <button class="btn btn-danger" style="flex:1;" id="confirmBtn">L√∂schen</button>
        </div>
    </div>`;
    document.body.appendChild(m);
    m.querySelector('#confirmBtn').onclick = () => { m.remove(); onConfirm(); };
}

// ========== HELPERS ==========
function escapeHtml(text) {
    const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
}
    </script>
</body>
</html>
